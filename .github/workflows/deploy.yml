name: 🚀 RAG CGI API DEPLOY

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      USER_SERVEUR: ${{ secrets.USER_SERVEUR }}
      IP_SERVEUR: ${{ secrets.IP_SERVEUR }}
      SSH_SERVEUR: ${{ secrets.SSH_SERVEUR }}

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🔐 Write SSH key
        run: |
          echo "${{ secrets.SSH_SERVEUR }}" > key.pem
          chmod 600 key.pem
          chmod +x scripts/*.sh

      - name: 🔨 Build image & push
        run: |
          chmod +x scripts/build_push_docker_img.sh
          ./scripts/build_push_docker_img.sh

      - name: 🚀 Deploy RAG CGI API by the pull_docker_img_executor.sh we execute the pull_docker_img.sh
        env:
          DEFAULT_MODEL: ${{ secrets.DEFAULT_MODEL }}
          TEMPERATURE: ${{ secrets.TEMPERATURE }}
          MAX_TOKENS: ${{ secrets.MAX_TOKENS }}
          MAX_SOURCES: ${{ secrets.MAX_SOURCES }}
          
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          VECTOR_STORE_TYPE: ${{ secrets.VECTOR_STORE_TYPE }}
          ENVIRONMENT: ${{ secrets.ENVIRONMENT }}
        run: |
          chmod +x scripts/pull_docker_img_executor.sh
          ./scripts/pull_docker_img_executor.sh key.pem

      - name: 🧱 Deploy NGINX config
        run: |
          chmod +x scripts/setup_nginx_config.sh
          ./scripts/setup_nginx_config.sh key.pem

      - name: 🔒 Configure SSL
        run: |
          chmod +x scripts/configure_ssl.sh
          ./scripts/configure_ssl.sh key.pem
      
      - name: 🔄 Reload NGINX
        run: |
          chmod +x scripts/reload_nginx.sh
          ./scripts/reload_nginx.sh key.pem

      - name: 🧹 Cleanup
        run: rm -f key.pem

      - name: Clean up SSH key
        run: rm -f key.pem