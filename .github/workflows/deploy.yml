name: ðŸš€ PCI APP BACKEND

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      USER_SERVEUR: ${{ secrets.USER_SERVEUR }}
      IP_SERVEUR: ${{ secrets.IP_SERVEUR }}
      SSH_SERVEUR: ${{ secrets.SSH_SERVEUR }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ” Write SSH key
        run: |
          echo "${{ secrets.SSH_SERVEUR }}" > key.pem
          chmod 600 key.pem
          chmod +x scripts/*.sh

      - name: ðŸ”¨ Build image & push
        run: |
          chmod +x scripts/build_push_docker_img.sh
          ./scripts/build_push_docker_img.sh

      - name: ðŸš€ Deploy backend by the pull_docker_img_executor.sh we execute the pull_docker_img.sh
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}

          MONGO_URL: ${{ secrets.MONGO_URL }}
          MONGO_DB_NAME: ${{ secrets.MONGO_DB_NAME }}

          EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}

          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        run: |
          chmod +x scripts/pull_docker_img_executor.sh
          ./scripts/pull_docker_img_executor.sh key.pem

      - name: ðŸ§± Deploy NGINX config
        run: |
          chmod +x scripts/setup_nginx_config.sh
          ./scripts/setup_nginx_config.sh key.pem

      - name: ðŸ”’ Configure SSL
        run: |
          chmod +x scripts/configure_ssl.sh
          ./scripts/configure_ssl.sh key.pem
      
      - name: ðŸ”„ Reload NGINX
        run: |
          chmod +x scripts/reload_nginx.sh
          ./scripts/reload_nginx.sh key.pem

      - name: ðŸ§¹ Cleanup
        run: rm -f key.pem

      - name: Clean up SSH key
        run: rm -f key.pem
